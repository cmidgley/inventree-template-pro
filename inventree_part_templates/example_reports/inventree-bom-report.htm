
{% extends "report/inventree_report_base.html" %}

{% load i18n %}
{% load report %}
{% load barcode %}
{% load inventree_extras %}
{% load part_templates %}

{% block page_margin %}
margin: 2cm;
margin-top: 4cm;
{% endblock page_margin %}

{% block bottom_left %}
content: "v{{ report_revision }} - {{ date.isoformat }}";
{% endblock bottom_left %}

{% block bottom_center %}
content: "{% inventree_version shortstring=True %}";
{% endblock bottom_center %}

{% block style %}
.header-right {
    text-align: right;
    float: right;
}

.borderless-table {
    border: 0px solid transparent;
    border-collapse: collapse;
    width: 100%;
    font-size: 80%;
}

.borderless-table td {
    border: 0px solid transparent;
    vertical-align: top;
}

.main-part-text {
    display: inline;
}

.main-part-description {
    display: inline;
}

.inventree-logo {
    height: 20mm;
    vertical-align: middle;
}

.main-part-logo {
    display: inline;
}

.main-part-logo-img {
    max-width: 120px;
    max-height: 120px;
}


.table-materials {
    text-align: left;
    width: 100%;
}

.table-materials td {
    vertical-align: top;
    padding-top: 10px;
}


.col-quantity {
    text-align: center;
    width: 100px;
}

.col-category {
    width: 250px;

}

.col-part {
}

.col-part-thumb {
    max-width: 32px;
    max-height: 32px;
    display: inline;
}

.col-part-text {
    display: block;
}

.col-part-description {
    display: block;
    font-weight: bold;
}

.col-build {
    width: 300px;
}

.col-reference {
    overflow-wrap: break-word;
    white-space: normal;
}

.error {
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12pt;
    color: red;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

{% endblock style %}

{% block header_content %}

    <img class='inventree-logo' src='{% logo_image %}' alt="InvenTree logo" width='150'>

    <div class='header-right'>
        <h3>{% trans "Bill of Materials" %}</h3>
    </div>

{% endblock header_content %}

{% block page_content %}
    {% if not part_templates %}
        <div class="error">{% trans "Plugin inventree-part-templates required" %}</div>
    {% elif part_templates.error %}
        <div class="error">{{ part_templates.error }}</div>
    {% else %}
        <table class="borderless-table">
            <tbody>
                <tr>
                    <td>
                        <h3>{% trans "Assembly for part:" %}</h3>
                        <div class='main-part-text'>
                            {{ part.full_name }}
                        </div>
                        <div class='main-part-description'>
                            {{ part.description }}
                        </div>
                    </td>
                    <td>
                        <div class='main-part-logo'>
                            <img src='{% part_image part height=480 %}' alt='{% trans "Image" %}' class='main-part-logo-img'>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>

        <h3>{% trans "Materials needed" %}</h3>
        <table class='table table-striped table-condensed table-materials'>
            <thead>
                <tr>
                    <th class="col-quantity">{% trans "Quantity" %}</th>
                    <th class="col-category">{% trans "Category" %}</th>
                    <th class="col-part">{% trans "Part" %}</th>
                    <th class="col-build">{% trans "Build Allocation(s)" %}</th>
                    <th class="col-reference">{% trans "Reference(s)" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for line in bom_items.all %}
                    {% part_context line.sub_part.pk as part_context %}
                    {% if not part_context %}
                        <tr>
                            <td colspan="5" class="error">{% trans "Plugin inventree-part-templates did not locate part" %} {{line.sub_part.pk }}</td>
                        </tr>
                    {% elif part_context.error %}
                        <tr>
                            <td colspan="5" class="error">{{ part_context.error }}</td>
                        </tr>
                    {% else %}
                        <tr>
                            <td class="col-quantity">{% decimal line.quantity %}</td>
                            <td class="col-category">{{ part_context.category }}</td>
                            <td class="col-part">
                                <table>
                                    <tr>
                                        <td>
                                            <img src='{% part_image line.sub_part height=240 %}' alt='{% trans "Image" %}' class='col-part-thumb'>
                                        </td>
                                        <td>
                                            <div class='col-part-text'>
                                                {{ line.sub_part.full_name }}
                                            </div>
                                            <div class='col-part-description'>
                                                {{ part_context.description }}
                                            </div>        
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td class="col-build">
                                {% for build in part.active_builds %}
                                    {% for allocated_stock in build.allocated_stock %}
                                        <div class="part-allocated-stock">
                                            {% if allocated_stock.bom_item.sub_part_id == line.sub_part.pk and not part_found %}
                                            {% blocktrans with quantity=allocated_stock.quantity|floatformat:"0" build_ref=build.reference %}
                                                {{quantity}} allocated to {{build_ref}}
                                            {% endblocktrans %}
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endfor %}
                            </td>
                            <td class="col-reference">{{ line.reference|replace:",|, " }}</td>
                        </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
{% endblock page_content %}
